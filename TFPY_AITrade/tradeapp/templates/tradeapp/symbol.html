{% extends "base.html" %}
{% load static %}

{% block title %}
Market {{sbl}}
{% endblock title %}

{% block content %}
{% comment %} Ticker and buttons {% endcomment %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
	<h1 id="symbol" class="h2">{{sbl}}</h1>
	<div class="btn-toolbar mb-2 mb-md-0">
		<div class="btn-group me-2">
			<button type="button" class="btn btn-sm btn-outline-secondary">
				Prediction
			</button>
		</div>
		<div class="btn-group me-2">
			<button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
			<button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
		</div>
		<div class="dropdown">
			<button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="actualSelectiondropdownMenuButton"
				data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<i class="fa-solid fa-calendar-days pe-1"></i>
				<span id='actualSelectionText'>{{actualSelection}}</span>
			</button>
			<div id="dateRangeSelector" class="dropdown-menu dropdown-menu-right" aria-labelledby="actualSelectiondropdownMenuButton">
				{% for selection in otherSelection %}
				<a class="selectionItem dropdown-item">{{selection}}</a>
				{% endfor %}
			</div>
		</div>
	</div>
</div>

{% comment %} Chart {% endcomment %}
<div class="my-4 w-100" id="TVChart" width="900" height="380"></div>

{% comment %} News {% endcomment %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
	<h1 id="symbol" class="h2">News</h1>
</div>

{% comment %} News block {% endcomment %}
<div class="row">
	<div class="col-md-4">
		<div class="card p-3 mb-2">
			<div class="d-flex justify-content-between">
				<div class="d-flex flex-row align-items-center">
					<div class="icon"> <i class="fa-solid fa-newspaper"></i> </div>
					<div class="ms-2 c-details">
						<h6 class="mb-0">
							new provider
						</h6> 
						<span>
							new date
						</span>
					</div>
				</div>
				<div class="badge"> 
					<span>
						new type
					</span>
				</div>
			</div>
			<div class="mt-5">
				<h3 class="heading">
					new tittle
				</h3>
				<div class="mt-5">
					<div class="mt-3">
						resumed new content
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!--
<div class="table-responsive">
	<table class="table table-striped table-sm">
		<thead>
			<tr>
				<th scope="col">#</th>
				<th scope="col">Header</th>
				<th scope="col">Header</th>
				<th scope="col">Header</th>
				<th scope="col">Header</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>1,001</td>
				<td>random</td>
				<td>data</td>
				<td>placeholder</td>
				<td>text</td>
			</tr>

		</tbody>
	</table>
</div>-->
{% endblock content %}

{% block scripts %}
{% comment %}
https://tradingview.github.io/lightweight-charts/
https://adamj.eu/tech/2020/02/18/safely-including-data-for-javascript-in-a-django-template/
https://www.youtube.com/watch?v=3KPW9VMyBHA
https://tradingview.github.io/lightweight-charts/docs
{% endcomment %}
<script type="text/javascript">
	function chartSetter(chart, candleData, volumeData, candlestickSeries, volumeSeries) {
		candlestickSeries.setData(candleData);
		volumeSeries.setData(volumeData);
		chart.timeScale().fitContent();
	}
	parent = document.getElementById('TVChart')
	var chart = LightweightCharts.createChart(parent, {
		width: parent.offsetWidth,
		height: 600,
		rightPriceScale: {
			scaleMargins: {
				top: 0.3,
				bottom: 0.25,
			},
			borderVisible: false,
		},
		layout: {
			backgroundColor: '#131722',
			textColor: '#d1d4dc',
		},
		grid: {
			vertLines: {
				color: 'rgba(42, 46, 57, 0)',
			},
			horzLines: {
				color: 'rgba(42, 46, 57, 0.6)',
			},
		},
	});
	var candlestickSeries = chart.addCandlestickSeries(
	);
	var volumeSeries = chart.addHistogramSeries({
		color: '#26a69a',
		priceFormat: {
			type: 'volume',
		},
		priceScaleId: '',
		scaleMargins: {
			top: 0.8,
			bottom: 0,
		},
	});

	chartSetter(chart, candleData = {{candleData|safe}}, volumeData = {{volumeData|safe}}, candlestickSeries, volumeSeries);

	// Responsive chart https://stackoverflow.com/questions/57898720/how-to-create-responsive-tradingview-lightweight-chart
	new ResizeObserver(entries => {
		if (entries.length === 0 || entries[0].target !== parent) { return; }
		const newRect = entries[0].contentRect;
		chart.applyOptions({ height: newRect.height, width: newRect.width });
	  }).observe(parent);

</script>
<script type="text/javascript"> //https://stackoverflow.com/questions/45906858/update-dom-without-reloading-the-page-in-django
$("#dateRangeSelector a").click(function (){
	var endpoint = '/ajax/get_response';
	var period = $(this).html();
	var symbol = $('#symbol').html();
	$.ajax({
		method: "GET",
        url: endpoint,
        data: {
          'period': period,
		  'sbl': symbol
        },
        dataType: 'json',
        success: function (data) {
        	chartSetter(chart, data.candleData, data.volumeData, candlestickSeries, volumeSeries);
			$('#actualSelectionText').text(data.actualSelection);
			var counter = 0;
			$('.selectionItem').each( function( index, element ){
				$(this).text(data.otherSelection[counter++].value);
			});			
        }
      });
});
</script>
{% endblock scripts %}