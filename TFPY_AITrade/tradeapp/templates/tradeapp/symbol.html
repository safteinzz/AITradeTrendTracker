{% extends "base.html" %}
{% load static %}

{% block title %}
Market {{sbl}}
{% endblock title %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
	<h1 id="symbol" class="h2">{{sbl}}</h1>
	<div class="btn-toolbar mb-2 mb-md-0">
		<div class="btn-group me-2">
			<button type="button" class="btn btn-sm btn-outline-secondary">
				Prediction
			</button>
		</div>
		<div class="btn-group me-2">
			<button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
			<button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
		</div>
		<div class="dropdown">
			<button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="actualSelectiondropdownMenuButton"
				data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<span data-feather="calendar"></span>
				{{actualSelection}}
			</button>
			<div id="dateRangeSelector" class="dropdown-menu dropdown-menu-right" aria-labelledby="actualSelectiondropdownMenuButton">
				{% for selection in otherSelection %}
				<a class="selectionItem dropdown-item">{{selection}}</a>
				{% endfor %}
			</div>
		</div>
	</div>
</div>

<div class="my-4 w-100" id="TVChart" width="900" height="380"></div>

<h2>News</h2>
<!--
<div class="table-responsive">
	<table class="table table-striped table-sm">
		<thead>
			<tr>
				<th scope="col">#</th>
				<th scope="col">Header</th>
				<th scope="col">Header</th>
				<th scope="col">Header</th>
				<th scope="col">Header</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>1,001</td>
				<td>random</td>
				<td>data</td>
				<td>placeholder</td>
				<td>text</td>
			</tr>

		</tbody>
	</table>
</div>-->
{% endblock content %}

{% block scripts %}
{% comment %}
https://tradingview.github.io/lightweight-charts/
https://adamj.eu/tech/2020/02/18/safely-including-data-for-javascript-in-a-django-template/
https://www.youtube.com/watch?v=3KPW9VMyBHA
https://tradingview.github.io/lightweight-charts/docs
{% endcomment %}
<script type="text/javascript">
	function chartSetter(chart, candleData, volumeData, candlestickSeries, volumeSeries) {
		candlestickSeries.setData(candleData);
		volumeSeries.setData(volumeData);
		chart.timeScale().fitContent();
	}

	var chart = LightweightCharts.createChart(document.getElementById('TVChart'), {
		width: 1540,
		height: 600,
		rightPriceScale: {
			scaleMargins: {
				top: 0.3,
				bottom: 0.25,
			},
			borderVisible: false,
		},
		layout: {
			backgroundColor: '#131722',
			textColor: '#d1d4dc',
		},
		grid: {
			vertLines: {
				color: 'rgba(42, 46, 57, 0)',
			},
			horzLines: {
				color: 'rgba(42, 46, 57, 0.6)',
			},
		},
	});
	var candlestickSeries = chart.addCandlestickSeries(
	);
	var volumeSeries = chart.addHistogramSeries({
		color: '#26a69a',
		priceFormat: {
			type: 'volume',
		},
		priceScaleId: '',
		scaleMargins: {
			top: 0.8,
			bottom: 0,
		},
	});

	chartSetter(chart, candleData = {{candleData|safe}}, volumeData = {{volumeData|safe}}, candlestickSeries, volumeSeries);
</script>
<script type="text/javascript"> //https://stackoverflow.com/questions/45906858/update-dom-without-reloading-the-page-in-django
$("#dateRangeSelector a").click(function (){
	var endpoint = '/ajax/get_response';
	var period = $(this).html();
	var symbol = $('#symbol').html();
	$.ajax({
		method: "GET",
        url: endpoint,
        data: {
          'period': period,
		  'sbl': symbol
        },
        dataType: 'json',
        success: function (data) {
        	chartSetter(chart, data.candleData, data.volumeData, candlestickSeries, volumeSeries);
			$('#actualSelectiondropdownMenuButton').text(data.actualSelection);
			var counter = 0;
			$('.selectionItem').each( function( index, element ){
				$(this).text(data.otherSelection[counter++].value);
			});			
        }
      });
});
</script>
{% endblock scripts %}